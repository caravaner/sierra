name: Deploy to Cloud Run

on:
  push:
    branches:
      - dev    # → staging
      - main   # → production

# Required for Workload Identity Federation (keyless GCP auth)
permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION:     ${{ vars.GCP_REGION }}
  REGISTRY:   ${{ vars.GCP_REGION }}-docker.pkg.dev

jobs:
  # ── Resolve environment from the branch that triggered the push ────────────
  resolve-env:
    name: Resolve target environment
    runs-on: ubuntu-latest
    outputs:
      env_name:          ${{ steps.resolve.outputs.env_name }}
      cloud_sql_instance: ${{ steps.resolve.outputs.cloud_sql_instance }}
      web_service:       ${{ steps.resolve.outputs.web_service }}
      admin_service:     ${{ steps.resolve.outputs.admin_service }}
      web_min_instances: ${{ steps.resolve.outputs.web_min_instances }}
      web_max_instances: ${{ steps.resolve.outputs.web_max_instances }}
      admin_min_instances: ${{ steps.resolve.outputs.admin_min_instances }}
      admin_max_instances: ${{ steps.resolve.outputs.admin_max_instances }}

    steps:
      - name: Resolve
        id: resolve
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "env_name=production"              >> $GITHUB_OUTPUT
            echo "cloud_sql_instance=${{ vars.CLOUD_SQL_INSTANCE_PROD }}"       >> $GITHUB_OUTPUT
            echo "web_service=sierra-web"           >> $GITHUB_OUTPUT
            echo "admin_service=sierra-admin"       >> $GITHUB_OUTPUT
            echo "web_min_instances=1"              >> $GITHUB_OUTPUT
            echo "web_max_instances=3"              >> $GITHUB_OUTPUT
            echo "admin_min_instances=0"            >> $GITHUB_OUTPUT
            echo "admin_max_instances=1"            >> $GITHUB_OUTPUT
          else
            echo "env_name=staging"                 >> $GITHUB_OUTPUT
            echo "cloud_sql_instance=${{ vars.CLOUD_SQL_INSTANCE_STAGING }}"    >> $GITHUB_OUTPUT
            echo "web_service=sierra-web-staging"   >> $GITHUB_OUTPUT
            echo "admin_service=sierra-admin-staging" >> $GITHUB_OUTPUT
            echo "web_min_instances=0"              >> $GITHUB_OUTPUT
            echo "web_max_instances=1"              >> $GITHUB_OUTPUT
            echo "admin_min_instances=0"            >> $GITHUB_OUTPUT
            echo "admin_max_instances=1"            >> $GITHUB_OUTPUT
          fi

  # ── Run database migrations ────────────────────────────────────────────────
  migrate:
    name: Migrate database (${{ needs.resolve-env.outputs.env_name }})
    runs-on: ubuntu-latest
    needs: resolve-env
    environment: ${{ needs.resolve-env.outputs.env_name }}   # triggers approval gate for production

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm --filter @sierra/db generate

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Start Cloud SQL Auth Proxy
        uses: google-github-actions/cloud-sql-proxy@v2
        with:
          instances: ${{ needs.resolve-env.outputs.cloud_sql_instance }}=tcp:5432

      - name: Run migrations
        run: pnpm --filter @sierra/db migrate:deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # ── Build images and deploy both apps ─────────────────────────────────────
  deploy:
    name: Deploy ${{ matrix.app }} → ${{ needs.resolve-env.outputs.env_name }}
    runs-on: ubuntu-latest
    needs: [resolve-env, migrate]
    environment: ${{ needs.resolve-env.outputs.env_name }}

    strategy:
      matrix:
        include:
          - app: web
            dockerfile: apps/web/Dockerfile
          - app: admin
            dockerfile: apps/admin/Dockerfile

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Resolve service name
        id: svc
        run: |
          if [[ "${{ matrix.app }}" == "web" ]]; then
            echo "name=${{ needs.resolve-env.outputs.web_service }}"           >> $GITHUB_OUTPUT
            echo "min=${{ needs.resolve-env.outputs.web_min_instances }}"      >> $GITHUB_OUTPUT
            echo "max=${{ needs.resolve-env.outputs.web_max_instances }}"      >> $GITHUB_OUTPUT
          else
            echo "name=${{ needs.resolve-env.outputs.admin_service }}"         >> $GITHUB_OUTPUT
            echo "min=${{ needs.resolve-env.outputs.admin_min_instances }}"    >> $GITHUB_OUTPUT
            echo "max=${{ needs.resolve-env.outputs.admin_max_instances }}"    >> $GITHUB_OUTPUT
          fi

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/sierra/${{ matrix.app }}:${{ needs.resolve-env.outputs.env_name }}
            ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/sierra/${{ matrix.app }}:${{ github.sha }}
          cache-from: type=gha,scope=${{ matrix.app }}-${{ needs.resolve-env.outputs.env_name }}
          cache-to:   type=gha,scope=${{ matrix.app }}-${{ needs.resolve-env.outputs.env_name }},mode=max

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ steps.svc.outputs.name }}
          region:  ${{ env.REGION }}
          image:   ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/sierra/${{ matrix.app }}:${{ github.sha }}
          flags: >-
            --min-instances=${{ steps.svc.outputs.min }}
            --max-instances=${{ steps.svc.outputs.max }}
            --concurrency=80
